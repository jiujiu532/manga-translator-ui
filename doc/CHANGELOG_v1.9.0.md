# v1.9.0 更新日志

发布日期：2024-11-28

## 🐛 Bug 修复

### 检测器修复
- **修复 YOLO 辅助检测器面积过滤参数传递问题**
  - 修复了 YOLO OBB 检测器未正确接收 `min_box_area_ratio` 参数的问题
  - 现在用户设置的最小检测框面积占比会正确应用到 YOLO 检测器
  - 解决了 UI 设置为 0 但实际使用默认值 0.0009 的问题

### 编辑器修复
- **修复编辑器描边宽度实时更新问题**
  - 修复了主页修改描边宽度后，编辑器中的文本描边没有实时更新的问题
  - 修复了参数服务导出时字段重命名导致的配置丢失问题
  - 现在主页修改描边宽度后，编辑器会立即重新渲染并应用新的描边宽度

### 错误处理优化
- **添加 API 404 错误的友好中文提示**
  - 检测 HTML 错误响应并提供详细的解决方案
  - 统一错误处理，所有翻译器共用
  - 避免无限重试，快速失败并显示清晰的错误提示

### 依赖安装修复
- **修复 SSL 证书验证失败问题**
  - 添加 `--trusted-host` 参数解决清华镜像源 SSL 证书问题
  - 同时支持清华源和 PyTorch 官方源的 SSL 跳过
  - 解决了 `aiofiles` 等依赖无法安装的问题

## 🔧 优化改进

### 内存优化
- **批量处理内存优化**
  - 添加批次间内存清理逻辑，预期减少 20-30% 内存占用
  - CLI 和 UI 模式改为按批次加载图片，避免一次性加载所有图片到内存
  - 对于 100 张图片的批量处理，内存占用从 5GB 降低到 150MB（节省 97%）
  - **修复导出模式的内存清理问题**
    - 导出原文模式现在会在批次完成后清理内存
    - 导出翻译模式现在会在批次完成后清理内存（标准和高质量模式）
    - 确保所有翻译模式（单文件、批量、高质量、导出原文、导出翻译、仅上色、仅超分）都会正确清理内存

### AMD GPU 支持优化
- **更新 AMD ROCm PyTorch 支持策略**
  - 移除对 RDNA 1 (RX 5000 系列) 和 RDNA 2 (RX 6000 系列) 的 GPU 加速支持
  - 这些显卡将自动使用 CPU 版本以获得更好的稳定性
  - 仅保留对 RDNA 3 (RX 7000 系列) 和 RDNA 4 (RX 9000 系列) 的 GPU 支持
  - 更新了安装脚本和文档说明

### overwrite 逻辑优化
- **改进 overwrite=False 时的处理逻辑**
  - 在翻译前预检查文件是否存在，避免重复处理
  - 支持标准翻译模式和高质量翻译模式
  - 导出原文模式：只检查原文 TXT 文件是否存在
  - 导出翻译模式：只检查翻译 TXT 文件是否存在
  - 普通翻译模式：检查输出图片文件是否存在
  - 跳过已存在的文件，显示清晰的日志信息

### 文件处理优化
- **修复递归文件夹排序问题**
  - 修改自然排序逻辑，使用完整路径而不是只使用文件名
  - 确保子文件夹按正确顺序处理（第1话、第2话、第10话）
  - 解决大文件夹包含多个小文件夹时的排序混乱问题
- **统一 CLI 和 UI 模式的文件处理顺序**
  - CLI 模式现在使用与 UI 模式相同的自然排序逻辑
  - 先对文件夹进行自然排序，再对每个文件夹内的图片排序

### 界面修复
- **修复文件夹选择对话框样式问题**
  - 修复了深色主题下 hover 状态文字不可见的问题
  - 优化了文件夹选择对话框的样式和交互体验

### 文档更新
- 更新 `requirements_amd.txt` 中的显卡支持说明
- 更新 README.md 中的 AMD GPU 支持信息
- 添加了不支持显卡的明确提示

## 📝 技术细节

### 代码变更
- `manga_translator/detection/__init__.py`: 修复 YOLO 检测器调用时的参数传递
- `manga_translator/manga_translator.py`: 添加批次间内存清理逻辑，添加 overwrite 预检查逻辑，修复导出模式内存清理
- `manga_translator/mode/local.py`: CLI 模式按批次加载图片，统一文件排序逻辑
- `desktop_qt_ui/app_logic.py`: UI 模式按批次加载图片，添加 404 错误处理
- `desktop_qt_ui/services/file_service.py`: 修复递归文件夹的自然排序逻辑
- `manga_translator/translators/openai_hq.py`: 检测 HTML 404 错误响应
- `desktop_qt_ui/editor/text_renderer_backend.py`: 修复描边宽度参数映射
- `desktop_qt_ui/editor/editor_controller.py`: 修复描边宽度参数传递
- `desktop_qt_ui/widgets/folder_dialog.py`: 修复深色主题下 hover 状态显示问题
- `packaging/launch.py`: 添加 `--trusted-host` 参数，注释掉 gfx101X-dgpu 和 gfx103X-dgpu 的自动检测
- `requirements_amd.txt`: 更新显卡支持说明和示例命令
- `README.md`: 更新 AMD GPU 支持范围说明
- `doc/INSTALLATION.md`: 更新系统要求和推荐翻译器说明

### 影响范围
- 使用 AMD RX 5000/6000 系列显卡的用户将自动使用 CPU 版本
- 使用 AMD RX 7000/9000 系列显卡的用户不受影响
- 所有用户的检测器面积过滤设置现在都能正确生效

## 🔄 升级说明

### 对于现有用户
1. 如果您使用的是 AMD RX 5000/6000 系列显卡：
   - 系统将自动引导您使用 CPU 版本
   - 这将提供更好的稳定性和兼容性

2. 如果您使用的是 AMD RX 7000/9000 系列显卡：
   - 继续使用 GPU 加速版本
   - 无需任何更改

3. 如果您之前设置了 `min_box_area_ratio` 参数：
   - 现在该参数会正确应用到所有检测器
   - 建议重新测试您的检测设置

## ⚠️ 注意事项

- AMD ROCm PyTorch 仍然是实验性功能
- 建议 AMD 用户在遇到问题时切换到 CPU 版本
- CPU 版本虽然速度较慢，但稳定性和兼容性最好
