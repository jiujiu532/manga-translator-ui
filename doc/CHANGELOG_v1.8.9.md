# v1.8.9 更新日志

发布日期：2025-01-23

---

## 🐛 Bug 修复

### API 服务器修复
- 修复 `get_work_dir()` 缺少必需参数的错误
- 修复流式端点的 Windows 文件锁定问题
- 使用 importlib 直接导入 workflow_service，避免触发 `__init__.py`
- 修复旋转检测时 mask 为 tuple 导致的错误
- 修复翻译结果为空时的错误处理
- 修复 web 模式缺少 nonce 和 start_instance 属性的错误
- 修复 web 模式命令行参数未生效的问题

### 翻译器修复
- **修复速率限制bug**：修复每分钟最大请求次数限制失效的问题
  - 问题：当API调用失败（网络错误、SSL错误等）时，时间戳在请求发送前就已更新，导致重试请求没有遵守速率限制
  - 修复：将时间戳更新移到API调用成功后，确保只有真正完成的请求才计入速率限制
  - 影响翻译器：OpenAI、OpenAI HQ、Gemini、Gemini HQ
- **添加速率限制日志**：当触发速率限制等待时，会打印 `Ratelimit sleep: X.XXs` 日志，方便调试

## 🎯 新增功能

### API 功能增强
- **临时文件清理**：添加 `/cleanup/temp` 端点用于清理临时文件
  - 支持自定义清理时间（默认 24 小时前的文件）
  - 自动跳过正在使用的文件（Windows 文件锁定）
- **默认配置支持**：API 未传入 config 时自动使用默认配置文件

### 检测器优化
- **最小检测框面积占比** (min_box_area_ratio)
  - 默认值：0.0009（0.09%）
  - 用于过滤面积过小的检测框，避免误检噪点
  - 可在配置文件中调整，建议范围：0.0005-0.002

### 命令行参数
- 添加 `--retry-attempts` 参数，控制翻译失败时的重试次数
- 为 web 模式添加 `--models-ttl` 参数，控制模型在内存中的保留时间

## � 改进优化

### UI 改进
- **动态刷新功能**：字体和提示词下拉菜单支持动态刷新
  - 添加新字体文件后，点击下拉菜单即可看到，无需重启程序
  - 添加新提示词文件后，点击下拉菜单即可看到，无需重启程序
- **隐藏废弃参数**：隐藏 `gimp_font` 参数，统一使用 `font_path`

### 参数整合
- **批量大小统一**：移除 `hq_batch_size` 参数，统一使用 `batch_size`
  - 对于高质量翻译器，`batch_size` 控制一次发送的图片数量
  - 建议范围：1-10

## 📚 文档改进

- 为所有参数添加英文名称
- 完善参数说明文档
- 更新 API 文档

---

**完整更新内容请查看**: [GitHub Releases](https://github.com/hgmzhn/manga-translator-ui/releases/tag/v1.8.9)
